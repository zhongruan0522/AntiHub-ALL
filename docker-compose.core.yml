services:
  web:
    # 国内请使用：swr.cn-north-4.myhuaweicloud.com/ddn-k8s/ghcr.io/zhongruan0522/antihub-web:latest
    image: ghcr.io/${IMAGE_OWNER:-zhongruan0522}/antihub-web:${IMAGE_TAG:-latest}
    container_name: antihub-web
    environment:
      NODE_ENV: production
      # Cookie 协议（影响 Set-Cookie 的 Secure 属性）：默认 HTTPS；用 IP 直连（HTTP）时改成 HTTP
      COOKIE_HTTP: ${COOKIE_HTTP:-HTTPS}
      Cookie-Http: ${COOKIE_HTTP:-HTTPS}
      # 可选：覆盖 web 容器内部访问 backend 的地址（容器内通常用 http://antihub-backend:8000）
      INTERNAL_API_BASE_URL: ${INTERNAL_API_BASE_URL:-}
      BACKEND_INTERNAL_URL: ${BACKEND_INTERNAL_URL:-}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - backend
    ports:
      - "127.0.0.1:${WEB_PORT:-3000}:3000"
    restart: unless-stopped

  backend:
    # 国内请使用：swr.cn-north-4.myhuaweicloud.com/ddn-k8s/ghcr.io/zhongruan0522/antihub-backend:latest
    image: ghcr.io/${IMAGE_OWNER:-zhongruan0522}/antihub-backend:${IMAGE_TAG:-latest}
    container_name: antihub-backend
    environment:
      APP_ENV: production
      LOG_LEVEL: ${LOG_LEVEL:-INFO}

      # 外部依赖（你自己提供/维护）
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL}

      # 内部互联（已预置）
      PLUGIN_API_BASE_URL: http://antihub-plugin:8045
      PLUGIN_API_ADMIN_KEY: ${PLUGIN_ADMIN_API_KEY}
      PLUGIN_API_ENCRYPTION_KEY: ${PLUGIN_API_ENCRYPTION_KEY}

      # 需要你自己配置的密钥/回调（外部可见）
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}
      JWT_ALGORITHM: HS256
      JWT_EXPIRE_HOURS: ${JWT_EXPIRE_HOURS:-24}
      REFRESH_TOKEN_EXPIRE_DAYS: ${REFRESH_TOKEN_EXPIRE_DAYS:-7}

      # 管理员账号配置（首次启动时自动创建）
      ADMIN_USERNAME: ${ADMIN_USERNAME:-}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:-}

    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      plugin:
        condition: service_started
    ports:
      - "127.0.0.1:${BACKEND_PORT:-8000}:8000"
    restart: unless-stopped

  plugin:
    # 国内请使用：swr.cn-north-4.myhuaweicloud.com/ddn-k8s/ghcr.io/zhongruan0522/antihub-plugin:latest
    image: ghcr.io/${IMAGE_OWNER:-zhongruan0522}/antihub-plugin:${IMAGE_TAG:-latest}
    container_name: antihub-plugin
    environment:
      NODE_ENV: production
      PORT: 8045

      # 外部依赖（你自己提供/维护）
      DB_HOST: ${PLUGIN_DB_HOST}
      DB_PORT: ${PLUGIN_DB_PORT:-5432}
      DB_NAME: ${PLUGIN_DB_NAME:-antigravity}
      DB_USER: ${PLUGIN_DB_USER}
      DB_PASSWORD: ${PLUGIN_DB_PASSWORD}

      REDIS_HOST: ${PLUGIN_REDIS_HOST}
      REDIS_PORT: ${PLUGIN_REDIS_PORT:-6379}
      REDIS_PASSWORD: ${PLUGIN_REDIS_PASSWORD:-}

      # 需要你自己配置的密钥/回调（外部可见）
      ADMIN_API_KEY: ${PLUGIN_ADMIN_API_KEY}
      OAUTH_CALLBACK_URL: ${PLUGIN_OAUTH_CALLBACK_URL:-}

    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped


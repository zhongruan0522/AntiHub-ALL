id,priority,phase,area,title,description,acceptance_criteria,test_mcp,review_initial_requirements,review_regression_requirements,dev_state,review_initial_state,review_regression_state,git_state,owner,refs,notes
"MPB-000","P1","1","both","冻结迁移范围与兼容性合同","基于 Report.md 冻结“合并 AntiHub-plugin → AntiHub-Backend”的范围/非目标/兼容性；确认必须保留的 public routes 与将废弃(410)的 routes，并形成可执行验收清单草稿。","新增或更新 `4-docs/merge-plugin-into-backend-scope.md`：包含范围/非目标/兼容性/必保留接口清单（来源 `4-docs/BACKEND_PUBLIC_ROUTES.csv`）/返回 410 接口清单（来源 `Report.md` 11.2.3，含替代路径与前端处理约定）/验收清单草稿；明确不再支持第三方直连 `AntiHub-plugin:8045`。","AUTOSERVER","文档必须可会议 review：每条接口都有“保留/410/替代路径”结论与依据；边界需覆盖 DB 单库、迁移范围（不迁移 plugin 历史消费日志）、兼容性承诺。","验收清单草稿可在 Phase 9 逐条执行并打勾；并与 `BACKEND_PUBLIC_ROUTES.csv` 与 410 清单保持一致（无相互矛盾项）。","已完成","已完成","已完成","已提交","","plan/2026-02-14_12-17-19-merge-plugin-into-backend.md:20;Report.md:1;4-docs/BACKEND_PUBLIC_ROUTES.csv:1;4-docs/merge-plugin-into-backend-scope.md:1","picked_reason:Phase1 先冻结范围与接口合同以降低后续实现返工;done_at:2026-02-15;evidence:新增 4-docs/merge-plugin-into-backend-scope.md 并落盘 keep/410/替代路径与验收清单草稿"
"MPB-010","P0","2","backend","盘点并落盘所有 plugin 触点","定位 Backend/Compose/Env 中所有指向 AntiHub-plugin 的调用、配置与依赖，形成唯一触点清单，为替换/删除提供依据。","落盘一份“触点表”（建议 `4-docs/plugin_touchpoints.csv`）：包含 文件/符号(或行号)/用途/替换策略/是否可删；运行 `rg -n ""AntiHub-plugin|:8045|plugin-api|PLUGIN""`（覆盖 `AntiHub-Backend/`、`docker/`、`docker-compose*.yml`、`.env*`）的所有命中均能在触点表中找到对应条目（或被明确标注为误报/不相关）。","AUTOSERVER","触点表必须覆盖真实调用链（HTTP 调用、配置项、环境变量、compose 依赖）；每条给出可执行的处理策略（本地实现/返回 410/删除）。","在 Phase 7 删除 compose plugin 前复跑搜索，确认运行时不再存在对 plugin 的依赖；触点表更新为“已处理/未处理”可追踪。","已完成","已完成","已完成","已提交","","plan/2026-02-14_12-17-19-merge-plugin-into-backend.md:25;AntiHub-Backend/app/services/plugin_api_service.py:1;AntiHub-Backend/app/api/routes/plugin_api.py:1;docker-compose.yml:1;.env.example:1;4-docs/plugin_touchpoints.csv:1","picked_reason:P0 先盘点触点以支撑后续替换/删除;done_at:2026-02-15;evidence:touchpoints 覆盖 rg 命中 match_lines=98 missing=0;manual_test:rg -n --hidden \"AntiHub-plugin|:8045|plugin-api|PLUGIN\" AntiHub-Backend docker docker-compose.yml docker-compose.core.yml docker-compose.local.yml .env.example"
"MPB-020","P0","3","backend","落地 Backend 单库 schema（Alembic）","按 Report.md 的最终数据模型在 AntiHub-Backend 中新增/调整表与约束，移除共享池相关历史语义，为本地实现与迁移提供 schema。","新增 Alembic 迁移（`AntiHub-Backend/alembic/versions/*`）创建/调整 `antigravity_accounts`、`antigravity_model_quotas` 等所需表，并落实索引/唯一约束；schema 中不再引入“共享池/共享优先级”语义（`is_shared`/`prefer_shared` 等），如为迁移期临时保留需明确标注；在干净 DB 上 `cd AntiHub-Backend; uv run alembic upgrade head` 成功，且能执行至少一次降级（例如 `alembic downgrade -1`）再升级回 head。","AUTOSERVER","重点 review：迁移可回滚；约束与索引命名/性能符合现有风格；新增唯一约束不会造成不可预期的数据冲突（必要时给出数据清理/迁移策略）。","在 docker compose 环境跑一遍 migrations 到 head；Backend 能启动且 Phase 4 相关接口可读写新表。","已完成","已完成","已完成","已提交","","plan/2026-02-14_12-17-19-merge-plugin-into-backend.md:30;Report.md:1;AntiHub-Backend/alembic/env.py:1;AntiHub-Backend/alembic/versions/195826d71f24_add_antigravity_tables.py:1;AntiHub-Backend/app/models/antigravity_account.py:1;AntiHub-Backend/app/models/antigravity_model_quota.py:1","picked_reason:P0 schema 先行以支撑 Phase4 本地实现与迁移;done_at:2026-02-15;validation_limited:Docker daemon 不可用（npipe docker_engine 不存在），无法在干净 DB 上真实执行 upgrade/downgrade;manual_test:启动 Docker Desktop/Engine 后，cd AntiHub-Backend; cp .env.example .env（填入可用 DATABASE_URL/REDIS_URL/JWT_SECRET_KEY/PLUGIN_API_ENCRYPTION_KEY）；uv run alembic upgrade head；uv run alembic downgrade -1；uv run alembic upgrade head;evidence:uv run alembic upgrade head --sql 与 downgrade head:f3a4b5c6d7e8 --sql 均成功生成 SQL；uv run python -m compileall 通过;risk:medium 未在真实 Postgres 上跑迁移"
"MPB-030","P0","4","backend","替换 /api/plugin-api 为本地实现（含 410）","保持 /api/plugin-api 路由不变，将账号与配额能力改为直接读写 Backend DB；废弃接口按约定返回 410，并对照 public routes 抽样验证。","`/api/plugin-api/accounts/*` 支持账号 CRUD/刷新/项目/凭证读取等且无任何对 `AntiHub-plugin` 的外部 HTTP 调用；`/api/plugin-api/quotas/user` 基于 `antigravity_model_quotas` 聚合返回（按 Report 约定）；`/api/plugin-api/quotas/shared-pool` 与 `/api/plugin-api/quotas/consumption` 返回 HTTP 410（含可读错误信息/替代路径提示）；对照 `4-docs/BACKEND_PUBLIC_ROUTES.csv` 做一次接口抽样 smoke（至少 cover 账号列表/详情/配额）并记录结果。","AUTOSERVER","保持对外 contract：路径/方法/字段命名尽量不变；鉴权与错误码一致；日志不泄露敏感信息；410 的响应对前端可直接展示/处理。","跑 Phase 9 的 public routes 扫描确认无缺失；复跑触点搜索确认 repo 中无 runtime 直连 plugin 的 HTTP 调用链。","已完成","已完成","已完成","已提交","","plan/2026-02-14_12-17-19-merge-plugin-into-backend.md:35;AntiHub-Backend/app/api/routes/plugin_api.py:1;AntiHub-Backend/app/services/plugin_api_service.py:1;AntiHub-Backend/app/models/antigravity_account.py:1;AntiHub-Backend/app/models/antigravity_model_quota.py:1;4-docs/BACKEND_PUBLIC_ROUTES.csv:1;Report.md:1","picked_reason:P0 核心路由先本地化以便后续移除 plugin 运行时依赖;done_at:2026-02-15;validation_limited:Docker daemon 不可用，无法启动干净 DB 与 Backend 做接口 smoke（含 BACKEND_PUBLIC_ROUTES 抽样验证）;manual_test:启动 Docker Desktop/Engine 后，docker compose up -d postgres redis backend（或按项目文档启动）；cd AntiHub-Backend; uv run alembic upgrade head；登录拿 JWT 后依次请求 GET /api/plugin-api/accounts；POST /api/plugin-api/accounts/import；GET /api/plugin-api/accounts/{cookie_id}；GET /api/plugin-api/accounts/{cookie_id}/quotas；GET /api/plugin-api/quotas/user；GET /api/plugin-api/quotas/shared-pool（期望 410 + alternative）；GET /api/plugin-api/quotas/consumption（期望 410 + alternative）；PUT /api/plugin-api/preference（期望 410）;evidence:accounts/quotas/user 均改为读写 antigravity_* 表且不再走 proxy_request；410 端点用 JSONResponse 返回 error+alternative；uv run python -m compileall app 通过;risk:high 未实际跑接口与鉴权回归"
"MPB-040","P1","5","backend","对齐上游渠道选择与流式转发（SSE）","将上游选择与流式转发能力统一到 Backend，实现与 plugin 等价的行为（错误码/超时/重试），并将关键状态落 Redis/DB 以支持多实例。","Backend 侧 `/v1/chat/completions` 在 `stream=true` 时可稳定输出 SSE/流式 token，`stream=false` 正常返回；渠道选择支持 Antigravity/Kiro/Qwen（按 `Report.md` 2.4，基于 API Key/标头可切换）并有最小文档说明；device flow 轮询、usage limits 背景同步等状态不使用进程内状态（重启/多实例一致）；用两组不同渠道账号完成一次“流式 + 非流式”回归并给出可复现步骤。","AUTOE2E","重点 review：SSE framing、上游错误码、超时与重试策略一致性；避免阻塞；Redis key/TTL 设计；敏感信息不落日志。","docker compose 环境做多实例一致性验证（至少 2 实例或重启对比）；确认前端/调用方关键链路无行为漂移。","未开始","未开始","未开始","未提交","","plan/2026-02-14_12-17-19-merge-plugin-into-backend.md:43;Report.md:1",""
"MPB-050","P1","6","backend","实现迁移开关 + 幂等迁移（plugin DB → Backend DB）","实现一次性迁移流程（账号/配额范围内），支持开关控制、分布式锁、多实例只跑一次、幂等可重试，并在开关开启时失败阻止启动。","`.env.example` 增加迁移开关与（仅迁移期）plugin DB 连接配置且默认关闭；Backend 在开关开启且配置完整时执行迁移，失败则阻止启动（按 `Report.md` 4.6）；迁移使用分布式锁保证多实例只跑一次；plugin UUID→`users.id` 映射有落盘记录；迁移可重复运行两次无重复/无数据漂移（抽样核对账号/配额）；提供本地验证步骤与抽样核对点。","AUTOSERVER","重点 review：锁与事务边界正确；幂等键/唯一约束覆盖；失败路径不留下半迁移数据；迁移期映射不进入运行时请求链路。","准备含 plugin DB 的环境跑迁移两次 + 启动一次；确认 Phase 4 接口读取到迁移后数据；开关关闭时不影响启动。","未开始","未开始","未开始","未提交","","plan/2026-02-14_12-17-19-merge-plugin-into-backend.md:49;Report.md:1;.env.example:1;docker/postgres/init/01-init-plugin-db.sh:1",""
"MPB-060","P0","7","both","Compose 收敛：移除 plugin 服务与 plugin DB 初始化","更新 Compose 文件移除 plugin 运行时服务与依赖；弃用/隔离 plugin DB 初始化脚本；保证无 plugin 的一键启动可用。","`docker-compose.yml`、`docker-compose.core.yml`（以及 `docker-compose.local.yml` 如存在）不再包含 `AntiHub-plugin` 服务或对其 `depends_on`；`docker/postgres/init/01-init-plugin-db.sh` 不再默认执行（删除或改为迁移期手动执行），默认不创建 plugin DB；`docker compose up -d` 在无 plugin 场景可启动，Backend 核心接口可用，日志中无 “proxy plugin” 调用。","AUTOE2E","Compose 变更需兼容 core 模式；迁移期配置与运行时配置隔离清晰；删除服务前确认 Phase 2 触点已处理完毕。","用全新 `.env`（从 `.env.example` 复制）做一次冷启动验证；确认无残留容器/端口 8045 依赖与无 plugin 相关错误日志。","未开始","未开始","未开始","未提交","","plan/2026-02-14_12-17-19-merge-plugin-into-backend.md:56;docker-compose.yml:1;docker-compose.core.yml:1;docker-compose.local.yml:1;docker/postgres/init/01-init-plugin-db.sh:1",""
"MPB-070","P0","8","both","前端适配 Analytics + 410 处理，并同步文档","前端切换到 Backend 本地数据源与 `/api/usage/requests/*`；移除对已废弃 plugin-era 接口的依赖；更新 README/4-docs 说明 plugin 下线与替代路径。","前端不再请求 `/api/plugin-api/quotas/consumption`、`/api/plugin-api/quotas/shared-pool` 等废弃接口；相关功能改用 Backend 新接口/本地表；对返回 410 的路径要么移除调用要么提供兼容提示（页面不硬崩）；`cd AntiHub; pnpm lint` 通过并手工走通关键页面（账号管理、配额/Analytics、调用测试页如有）；`README.md` 与相关 `4-docs/*` 更新并明确“最终不部署 plugin”、迁移开关与替代路径。","AUTOFRONTEND","重点 review：API client 层统一处理 410；避免写死 plugin host；类型/字段与 Phase 4 保持一致；关注 Analytics 渲染性能与错误兜底。","联调回归：无 plugin 的 compose + 前端 dev/build 跑一轮；确认 UI 无控制台错误、接口无 5xx；对 410 路径提示清晰。","未开始","未开始","未开始","未提交","","plan/2026-02-14_12-17-19-merge-plugin-into-backend.md:62;README.md:1;4-docs/BACKEND_PUBLIC_ROUTES.csv:1",""
"MPB-080","P0","9","both","按清单执行验收/回归并可脚本化","在无 plugin 的部署形态下执行启动验收、迁移验收与 public routes 合同验收，输出可复制的回归流程，并保留应急回滚路径。","落盘可复制的验收文档/脚本（覆盖：无 plugin 启动验收、迁移验收、410 校验、public routes 扫描、回滚预案）；public routes 扫描基于 `4-docs/BACKEND_PUBLIC_ROUTES.csv`，至少验证路由可达性/状态码并记录执行结果；在 compose 环境完成一次完整回归：无 plugin、核心接口 OK；如开启迁移则迁移成功且数据抽样正确。","AUTOE2E","验收步骤必须可复制（命令明确、依赖说明）；扫描脚本避免破坏性写操作；回滚路径必须显式开关且仅用于应急。","在新环境或重置 volumes 后重复执行验收，确保流程稳健；问题与修复闭环记录到 PR/notes。","未开始","未开始","未开始","未提交","","plan/2026-02-14_12-17-19-merge-plugin-into-backend.md:68;4-docs/BACKEND_PUBLIC_ROUTES.csv:1;Report.md:1;docker-compose.yml:1",""

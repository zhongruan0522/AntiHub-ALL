"id","priority","phase","area","title","description","acceptance_criteria","test_mcp","review_initial_requirements","review_regression_requirements","dev_state","review_initial_state","review_regression_state","git_state","owner","refs","notes"
"RPT-010","P0","1","backend","固化 Spec×config_type 白名单矩阵常量（现状/目标态）","把 Report.md 的建议白名单整理为 Spec -> allowed config_type 的单一事实来源；保留目标态集合但默认不启用。","存在可复用的 allowlist 映射（覆盖 OAIResponses/OAIChat/Claude/Gemini）；内容与 Report.md 3.1-3.4 一致；后续路由校验只读取该映射（不再散落硬编码）。","AUTOSERVER","结构用最简单的 dict+set/tuple；现状/目标态分离且默认只用现状；加注释指向 Report.md；避免重复定义。","全仓 review：Spec 白名单不再在各路由里硬编码；新增 spec/config_type 只需改一处且有对应注释/文档。","已完成","已完成","已完成","已提交","","plan/2026-01-31_10-23-51-report-md-plan.md:16;Report.md:61;Report.md:65;Report.md:71;Report.md:77;Report.md:83;AntiHub-Backend/app/core/spec_allowlist.py:17;AntiHub-Backend/app/api/routes/gemini.py:173","picked_reason:先固化白名单矩阵作为单一事实来源，后续校验与路由改造都依赖它; done_at:2026-01-31; evidence:added spec allowlist constants + gemini route reads from default allowlist; evidence:python -m py_compile ok"
"RPT-020","P0","2","backend","后端增加统一白名单校验入口（ensure_spec_allowed）","新增统一校验函数/依赖，负责按 allowlist 判定是否放行；拒绝时统一返回 403 + detail=不支持的规范。","提供可复用的 ensure_spec_allowed(spec, config_type)（或 FastAPI dependency）；拒绝时 HTTP 403 且 detail 文案完全一致；允许时不改变原有业务路径。","AUTOSERVER","接口签名稳定、可单测；不引入循环依赖；日志可定位 spec/config_type 但不泄露 key；默认走“现状 allowlist”。","所有 Spec 路由接入后：错误码/文案一致；没有“路由内部各自 raise 403”的重复实现。","已完成","已完成","已完成","已提交","","plan/2026-01-31_10-23-51-report-md-plan.md:21;Report.md:16;AntiHub-Backend/app/core/spec_guard.py:21;AntiHub-Backend/app/core/spec_allowlist.py:39","picked_reason:这是后续各 Spec 路由统一 403 文案与白名单复用的基础入口，先做能减少重复改动; done_at:2026-01-31; validation_limited:local python env missing passlib -> cannot import app package to run runtime checks; manual_test:cd AntiHub-Backend && uv sync && uv run python -c ""from app.core.spec_guard import ensure_spec_allowed; ensure_spec_allowed(\""OAIResponses\"", \""codex\"")""; evidence:python -m py_compile ok; risk:low 仅新增通用函数，未接入任何路由逻辑"
"RPT-030","P1","3.1","backend","Gemini v1beta：非白名单统一 403 文案","保留 gemini-cli/zai-image 放行；非白名单统一 403 + detail=不支持的规范（不再提示允许列表）。","Gemini v1beta 的 generateContent/streamGenerateContent：config_type 不在 allowlist 时返回 403 且 detail=不支持的规范；gemini-cli/zai-image 行为不变。","AUTOSERVER","复用 ensure_spec_allowed；不改动允许集合；确保 stream 与非 stream 一致；不要在错误消息里泄露允许列表。","回归：gemini-cli/zai-image 正常；任意其它 type 均为 403 且文案一致；与其它 Spec 的 403 行为一致。","已完成","已完成","已完成","已提交","","plan/2026-01-31_10-23-51-report-md-plan.md:23;Report.md:33;Report.md:85;AntiHub-Backend/app/api/routes/gemini.py:35;AntiHub-Backend/app/api/routes/gemini.py:174;AntiHub-Backend/app/api/routes/gemini.py:173;AntiHub-Backend/app/api/routes/gemini.py:411","picked_reason:同一文件刚改过 Gemini allowlist，顺手把 stream/non-stream 的 403 文案统一并彻底消除残留硬编码; done_at:2026-01-31; validation_limited:local python env missing passlib -> cannot run FastAPI runtime/import checks; manual_test:docker compose up -d && curl -sS -D- http://localhost:8000/v1beta/models/gemini-1.5-pro:generateContent -H ""Authorization: Bearer <gemini-cli_key>"" -H ""Content-Type: application/json"" -d ""{\""contents\"":[{\""parts\"":[{\""text\"":\""hi\""}]}]}""; manual_test:use non-allowlisted key call both generateContent/streamGenerateContent expect 403 detail=不支持的规范; evidence:both endpoints now call ensure_spec_allowed(""Gemini"", config_type) -> unified 403 detail; evidence:python -m py_compile ok; risk:medium 行为变更：Gemini v1beta 非白名单错误文案统一且不再暴露允许列表"
"RPT-040","P0","3.2","backend","OAIResponses：仅放行 codex，禁止隐式转 ChatCompletions","按“建议拉黑”收敛 /v1/responses：除 codex 外全部 403，避免 Responses 请求被悄悄走到其它后端。","POST /v1/responses：effective_config_type!=codex 时返回 403 且 detail=不支持的规范；codex 行为不变；不再把 Responses request 转成 ChatCompletions 去走 kiro/antigravity/qwen。","AUTOSERVER","拦截点放在 responses() 入口最前；复用 ensure_spec_allowed；不要影响 codex 分支；日志要能定位被拦截的 type。","回归：codex responses 正常（含 stream/non-stream）；antigravity/kiro/qwen/gemini-cli 等均 403 且文案一致；不影响 /v1/chat/completions。","已完成","已完成","已完成","已提交","","plan/2026-01-31_10-23-51-report-md-plan.md:24;Report.md:65;Report.md:69;AntiHub-Backend/app/api/routes/v1.py:634;AntiHub-Backend/app/api/routes/v1.py:670;AntiHub-Backend/app/api/routes/v1.py:666","picked_reason:P0 且能立刻消除 /v1/responses 隐式转 ChatCompletions 的走错后端风险; done_at:2026-01-31; validation_limited:local python env missing passlib -> cannot run FastAPI runtime/import checks; manual_test:docker compose up -d && curl -sS -D- http://localhost:8000/v1/responses -H ""Authorization: Bearer <codex_key>"" -H ""Content-Type: application/json"" -d ""{\""model\"":\""gpt-4.1\"",\""input\"":\""hi\""}""; manual_test:use non-codex key call /v1/responses expect 403 detail=不支持的规范; evidence:removed Responses->ChatCompletions conversion path; enforced allowlist via ensure_spec_allowed; evidence:python -m py_compile ok; risk:medium 行为变更：/v1/responses 现在仅放行 codex（符合 Report/CSV 约束）"
"RPT-050","P0","3.3","backend","Claude（Anthropic Messages）：API key 模式补齐 config_type 白名单","对 /v1/messages 的 API key 模式做真正的 Spec 白名单：现状只放行 antigravity/kiro；非白名单统一 403。","POST /v1/messages：API key 模式下 config_type 不在 allowlist 时返回 403 且 detail=不支持的规范；antigravity/kiro 仍可用；codex/gemini-cli/qwen 等按策略被拒绝（qwen 等后续支持项另开）。","AUTOSERVER","区分 JWT 与 API key 两条分支；复用 ensure_spec_allowed；拒绝在后端完成（不要让 plug-in 兜底）；保证 403 文案一致。","回归：JWT header 约束不被破坏；API key 非白名单不再悄悄走 antigravity；与 plug-in 的“禁止默认回退”策略一致。","已完成","已完成","已完成","已提交","","plan/2026-01-31_10-23-51-report-md-plan.md:25;Report.md:52;Report.md:56;Report.md:77;AntiHub-Backend/app/api/routes/anthropic.py:126;AntiHub-Backend/app/api/routes/anthropic.py:131;AntiHub-Backend/app/api/routes/anthropic.py:162;AntiHub-Backend/app/api/routes/anthropic.py:132","picked_reason:P0 且能阻止 Claude spec 在 API key 模式下被非白名单渠道悄悄走到 antigravity（高风险走错后端）; done_at:2026-01-31; validation_limited:local python env missing passlib -> cannot run FastAPI runtime/import checks; manual_test:docker compose up -d && curl -sS -D- http://localhost:8000/v1/messages -H ""Authorization: Bearer <antigravity_or_kiro_key>"" -H ""Content-Type: application/json"" -d ""{\""model\"":\""claude-3-5-sonnet-latest\"",\""max_tokens\"":16,\""messages\"":[{\""role\"":\""user\"",\""content\"":\""hi\""}]}""; manual_test:use non-allowlisted key (codex/qwen/gemini-cli) call /v1/messages expect 403 detail=不支持的规范; evidence:enforced allowlist in API key branch via ensure_spec_allowed(""Claude"", config_type); evidence:python -m py_compile ok; risk:medium 行为变更：Claude spec 的 API key 模式开始严格白名单（非白名单 403）"
"RPT-060","P1","4.1","backend","OAIChat×Codex：补齐 ChatCompletions <-> Responses 适配（含 SSE）","让 config_type=codex 在 /v1/chat/completions 可用：Chat 请求转 Responses；Responses 响应/流式再转回 Chat。","POST /v1/chat/completions：config_type=codex 时不再 400；non-stream 返回合法 ChatCompletions；stream 返回 ChatCompletions SSE 且持续增量输出；复用现有 openai_responses_compat 并补齐缺失的反向转换与 SSE translator。","AUTOSERVER","转换器边界清晰、无跨层泄漏；对 codex 不支持参数有明确处理（忽略或 4xx）；stream translator 不丢事件/不乱序。","回归：其它 config_type 的 /v1/chat/completions 行为不变；/v1/responses codex 行为不变；对比响应 schema 与 OpenAI 兼容。","未开始","未开始","未开始","未提交","","plan/2026-01-31_10-23-51-report-md-plan.md:27;Report.md:91;Report.md:104;AntiHub-Backend/app/api/routes/v1.py:1297;AntiHub-Backend/app/utils/openai_responses_compat.py:9;AntiHub-Backend/app/utils/openai_responses_compat.py:154;AntiHub-Backend/app/services/codex_service.py:72",""
"RPT-070","P1","4.2","both","Gemini v1beta×Antigravity：实现 Gemini <-> OpenAI Chat 翻译闭环（路线A）","按路线A打通：Gemini 请求转 OpenAI ChatCompletions 走 plug-in antigravity；再把输出翻译回 Gemini（含 SSE）。","Gemini v1beta：config_type=antigravity 时不再 403；generateContent 与 streamGenerateContent 都可用；返回体/流式事件符合 Gemini v1beta 规范；非白名单仍 403 且文案一致。","AUTOE2E","把“协议翻译”隔离成独立模块；流式转换按行/事件处理不丢 token；失败时返回可诊断错误（不要静默吞）。","回归：gemini-cli/zai-image 原行为不变；docker compose 下真实链路 curl 可复现成功；不引入新的隐式回退。","未开始","未开始","未开始","未提交","","plan/2026-01-31_10-23-51-report-md-plan.md:28;Report.md:111;Report.md:120;AntiHub-Backend/app/api/routes/gemini.py:35;AntiHub-Backend/app/api/routes/gemini.py:174;AntiHub-plugin/src/server/routes.js:2396",""
"RPT-080","P1","4.3","backend","Claude×Qwen：多模态 content list 做最小可用降级（保文本丢图）","为 config_type=qwen 的 Claude 规范增加 sanitize/专用 converter：把 content blocks 扁平化为纯文本，避免上游 400。","POST /v1/messages：config_type=qwen 时，遇到多模态 content list 不再直接 400；至少纯文本可用（图片可降级丢弃但需有明确注释/行为说明）；仅影响 qwen，不影响其它渠道。","AUTOE2E","sanitize 只对 qwen 生效；对 tools/tool_choice 等字段做保守处理；转换逻辑有单一入口，避免散落 if/else。","回归：OAIChat 的 qwen 不受影响；Claude 的 antigravity/kiro 行为不变；真实样例（含图片块）不再 400。","未开始","未开始","未开始","未提交","","plan/2026-01-31_10-23-51-report-md-plan.md:29;Report.md:125;Report.md:135;AntiHub-Backend/app/services/anthropic_adapter.py:234;AntiHub-plugin/src/server/routes.js:1630;AntiHub-Backend/app/api/routes/anthropic.py:126",""
"RPT-090","P0","5","backend","AntiHub-plugin：Gemini(antigravity) SSE 改为按行缓冲，修复截断/缺字","修复 plug-in SSE 解析：不再 chunk.split(""\\n"")；改为跨 chunk 缓冲拼接，避免 JSON 拆包被静默丢弃。","AntiHub-plugin Gemini SSE 解析支持跨 chunk 拼接；拆包的 JSON 不再被丢弃；长输出不再出现“后半段缺字/截断”。","AUTOSERVER","实现用最朴素的 buffer+while(""\n"")；注意内存上限与异常处理；解析失败要可观测（至少 debug 日志/计数）。","回归：既有 SSE 流不受影响；与后端/代理组合下不再复现截断；后续单测（另 issue）能稳定覆盖拆包场景。","未开始","未开始","未开始","未提交","","plan/2026-01-31_10-23-51-report-md-plan.md:30;Report.md:142;Report.md:149;AntiHub-plugin/src/api/client.js:113;AntiHub-Backend/app/services/gemini_cli_api_service.py:918",""
"RPT-100","P0","6","backend","AntiHub-plugin：禁止未知/不支持类型默认回退 antigravity","修改 plug-in account type 解析与默认分支：未知/不支持类型直接失败，禁止静默走 antigravity 兜底。","plug-in 不再对未知 accountType 默认走 antigravity；遇到未知/不支持类型返回明确 4xx；已支持类型（qwen/kiro/antigravity 等）行为不变。","AUTOSERVER","默认分支必须 fail-fast；错误码/消息清晰；与后端 Spec 白名单策略一致；不要引入新的“偷偷改 type”行为。","回归：后端非白名单请求不会被 plug-in 悄悄跑通；已支持类型链路可用；日志能定位被拒绝的类型。","未开始","未开始","未开始","未提交","","plan/2026-01-31_10-23-51-report-md-plan.md:31;Report.md:181;AntiHub-plugin/src/server/routes.js:22;AntiHub-plugin/src/server/routes.js:1598",""
"RPT-110","P1","7","backend","GeminiCLI：思维链/流式压到最后输出的定位与修复（含排障开关+部署约束）","增加可开关 raw SSE 采样日志；修正 reasoning_content 映射（如字段不匹配）；补齐/文档化 SSE 防缓冲头与部署侧禁 gzip/buffering 要求。","提供默认关闭的 raw SSE 采样开关（启用时可抓取并脱敏）；reasoning_content 在上游提供 thought 信息时能正确透出；SSE 响应头包含 X-Accel-Buffering: no 等；文档明确代理层对 text/event-stream 的要求。","AUTOE2E","日志必须可控（开关+脱敏+限量）；不要影响正常性能；字段映射改动需有样例/注释支撑；响应头设置集中且可回归。","回归：开关关闭时无额外日志；开启时能拿到 raw SSE 片段；部署侧按文档配置后流式不再“最后一秒一起吐”。","未开始","未开始","未开始","未提交","","plan/2026-01-31_10-23-51-report-md-plan.md:32;Report.md:152;Report.md:157;Report.md:158;AntiHub-Backend/app/services/gemini_cli_api_service.py:588;AntiHub-Backend/app/api/routes/v1.py:1373",""
"RPT-120","P1","8","backend","API Keys：新增 PATCH /api-keys/{key_id}/type 修改渠道类型","在后端补齐对外接口更新 config_type，复用 APIKeyRepository.update_type(...)，并补齐鉴权、校验与审计日志。","新增 PATCH /api-keys/{key_id}/type（或等价合并接口）可用；仅授权用户可操作；config_type 输入校验明确（非法值 422）；成功后可查询到类型已更新；写入审计日志。","AUTOSERVER","不要破坏现有 API；校验枚举与 DB 一致；审计日志不泄露 key 明文；错误码一致且可诊断。","回归：更新类型后相关路由按新 type 生效；非法/未授权场景覆盖；与 Spec 白名单策略联动验证。","未开始","未开始","未开始","未提交","","plan/2026-01-31_10-23-51-report-md-plan.md:35;Report.md:167;Report.md:171;AntiHub-Backend/app/api/routes/api_keys.py:1;AntiHub-Backend/app/repositories/api_key_repository.py:139",""
"RPT-130","P0","9.1","backend","后端：补齐白名单/适配/Key Type 的最小测试集","为 Spec 白名单矩阵、Codex Chat 适配、API key type patch 补最小自动化测试，锁住 403 文案与关键回归点。","每个 Spec 至少 1 个允许 + 1 个拒绝用例（断言 403 + 不支持的规范）；覆盖 /v1/responses 非 codex 被拒绝；覆盖 PATCH key type 成功/非法值；测试可在本地稳定运行。","AUTOSERVER","测试不打真实上游（mock/service stub）；断言包含状态码+detail；用例命名能看懂策略边界。","回归：在 docker compose / 本地环境跑测试无 flaky；改动路由时能第一时间报出策略回归。","未开始","未开始","未开始","未提交","","plan/2026-01-31_10-23-51-report-md-plan.md:37;Report.md:16;AntiHub-Backend/app/api/routes/v1.py:634;AntiHub-Backend/app/api/routes/gemini.py:174;AntiHub-Backend/app/api/routes/anthropic.py:126",""
"RPT-140","P0","9.2","backend","plug-in：SSE 行缓冲的单测覆盖（JSON 拆包不丢 token）","为 SSE 行缓冲逻辑加单测：构造跨 chunk 拆包的 JSON 行序列，验证不会静默丢事件/丢 token。","存在可运行的单测覆盖“JSON 被拆到两个 chunk”的场景；在旧实现上应失败、在新实现上通过；用例不依赖网络。","AUTOSERVER","测试用例小而硬；断言输出 token/event 数量与内容；避免引入脆弱的时间相关断言。","回归：npm test/ci 下稳定通过；未来改动 SSE 解析不会再引入截断回归。","未开始","未开始","未开始","未提交","","plan/2026-01-31_10-23-51-report-md-plan.md:38;Report.md:142;AntiHub-plugin/src/api/client.js:113",""
"RPT-150","P0","9.3","both","端到端：docker compose smoke + curl 回归 + 文档落地支持矩阵","跑一遍 compose 联调：验证各 Spec 403 行为、流式实时性与不再截断；在 4-docs/ 落盘“支持矩阵+白名单策略+回滚/排障要点”。","docker compose up -d 后可用 curl 复测：非白名单统一 403+不支持的规范；允许的 Spec/渠道可正常返回；stream 持续增量输出且不再截断；新增 4-docs 文档包含支持矩阵/白名单/回滚开关(如有)/SSE 禁 buffering 要求。","AUTOE2E","回归脚本/命令可复制粘贴；文档不写废话（只写策略边界+怎么验证+怎么回滚）；避免记录任何密钥/内部地址。","回归：按文档步骤在干净环境可复现；对比改动前后行为差异清晰；失败时能定位到具体 Spec/type。","未开始","未开始","未开始","未提交","","plan/2026-01-31_10-23-51-report-md-plan.md:39;plan/2026-01-31_10-23-51-report-md-plan.md:40;docker-compose.yml:1",""

---
mode: plan
cwd: C:\Users\zhongruan\Desktop\GitHub\AntiHub-ALL
task: 根据 Report.md 落地渠道/规范白名单与关键修复
complexity: complex
planning_method: builtin
created_at: 2026-01-31T10:23:51+08:00
---

# Plan: 根据 Report.md 生成可落地执行计划

🎯 任务概述
本计划基于 `Report.md` 的证据与建议，目标是在后端/plug-in 两侧落地“按规范(Spec)对白名单渠道(config_type)放行”的策略：先按报告里“建议白名单（现状）”收敛行为，再在修复完成后逐步推进到“目标态白名单”。同时统一对外 403 行为、消除 plug-in 默认回退 antigravity 的隐性路由，修复已确认的流式截断问题，并补齐“API Key 修改渠道类型”的对外接口。

📋 执行计划
1. 固化矩阵（Spec × config_type）并写入代码常量：从 `Report.md` 的 CSV 转写表 + 第 3 节白名单建议，整理成 allowlist 映射（Spec -> allowed config_type 集合），作为后续所有路由的单一事实来源。
   - OAIResponses：现状/目标态都只放行 `{ codex }`
   - OAIChat：现状放行 `{ antigravity, kiro, qwen, gemini-cli }`；目标态在修复后加入 `{ codex }`
   - Claude：现状放行 `{ antigravity, kiro }`；目标态在修复后加入 `{ qwen }`
   - Gemini v1beta：现状放行 `{ gemini-cli, zai-image }`；目标态在补齐后加入 `{ antigravity }`
2. 后端增加统一白名单校验入口：在 `AntiHub-Backend` 新增一个小的校验函数/依赖（例如 `ensure_spec_allowed(spec, config_type)`），对“不在白名单”的请求统一返回 `403` + `detail=不支持的规范`，并保证所有路由复用同一实现。
3. 规范级白名单落地（先做“建议拉黑”）：
   - Gemini v1beta：保留 `gemini-cli/zai-image` 放行，但把当前错误信息改为统一 `不支持的规范`。
   - OAIResponses：按 CSV 约束，仅放行 `codex`，其余渠道直接 403（避免 Responses 被隐式转成 ChatCompletions 走错后端）。
   - Claude（Anthropic Messages）：对 API key 模式补齐真正的 config_type 白名单（现状 `antigravity/kiro`；修复 qwen 后再放开）。
4. 补齐“建议支持”的缺实现：
   - OAIChat × Codex：实现 ChatCompletions -> Responses 的适配（尽量复用 `/v1/responses` 的 codex 分支逻辑），做到 `config_type=codex` 在 `/v1/chat/completions` 可用（含 stream/non-stream）。按 report 的落点，需要补齐 `openai_responses_compat.py` 里缺失的反向转换与 SSE translator（Responses SSE -> Chat SSE）。
   - Gemini v1beta × Antigravity：按 report 标注的“报错|建议支持”，需要做“协议翻译”而不是只放开白名单；两条路线：A) Gemini -> OpenAI ChatCompletions -> plug-in antigravity，再翻回 Gemini；B) 直接走 plug-in 的 Gemini 上游能力（目前看更像图片路由）。默认推荐先做路线 A（最小闭环）。
   - Claude × Qwen：针对 report 提到的“多模态 content list”导致的上游 400，优先做最小可用修复（把 content blocks 扁平化为纯文本/丢图保文），避免请求直接炸；实现位置二选一：Qwen 专用 converter（Anthropic -> Qwen）或在 Claude 路由层对 qwen 做 sanitize。
5. 修复已确认的流式截断：在 `AntiHub-plugin` 修复 Gemini(antigravity) SSE 解析为“按行缓冲”而不是 `chunk.split('\\n')`，保证跨 chunk 的 JSON 不会被静默丢弃（解决“输出完思维后截断/缺字”）。
6. 消除 plug-in 的隐式回退：修改 `AntiHub-plugin/src/server/routes.js` 的 account type 解析与默认分支逻辑，禁止未知/不支持类型默认走 `antigravity`；与后端白名单策略对齐，做到“不允许就明确失败”。
7. GeminiCLI 的“思维链缺失/流式压到最后输出”定位与修复：
   - 增加可开关的 raw SSE 采样日志（仅开发/排障启用），确认上游 thought 字段结构；必要时调整 `reasoning_content` 映射字段。
   - 在文档中明确部署侧对 `text/event-stream` 的要求（禁 gzip / 禁 buffering），并在后端响应头保持 `X-Accel-Buffering: no` 等约束。
8. 补齐“API Key 修改渠道类型”对外接口：在 `AntiHub-Backend/app/api/routes/api_keys.py` 增加 `PATCH /api-keys/{key_id}/type`（或合并到 PATCH key），调用现有 `APIKeyRepository.update_type(...)`；同步补齐鉴权、输入校验与审计日志。
9. 测试/回归与文档：
   - 后端：为白名单矩阵添加最小集成测试（每个 spec 至少覆盖 1 个允许 + 1 个拒绝，断言 403 文案一致）；为 codex chat 适配与 key type patch 补测试。
   - plug-in：为 SSE 行缓冲加单测（构造“JSON 被拆包”的 chunk 序列，断言不会丢 token）。
   - 端到端：`docker compose up -d` 跑一遍 smoke，curl 验证各 spec 的 403 行为、stream 是否实时、不再出现截断。
   - 文档：在 `4-docs/` 追加一份“渠道×规范支持矩阵 + 白名单策略 + 回滚开关（如有）”说明。

⚠️ 风险与注意事项
- 行为变更风险：白名单落地会把过去“能跑但走错后端/错计费”的灰色请求变成 403；建议在上线前对日志做一次采样统计，并准备一键回滚开关（例如环境变量切换 enforce/audit）。
- GeminiCLI 的“最后一秒吐完”可能是代理层 buffering/gzip 导致，代码侧只能部分缓解；需要和部署配置联动验证。
- 适配层复杂度：Codex Chat<->Responses、Claude/Qwen 内容结构降级都可能引入边界行为差异，需要用真实请求样本做回归。

📎 参考
- `Report.md`
- `AntiHub-Backend/app/api/routes/gemini.py:35`
- `AntiHub-Backend/app/api/routes/gemini.py:174`
- `AntiHub-Backend/app/api/routes/v1.py:634`
- `AntiHub-Backend/app/api/routes/v1.py:670`
- `AntiHub-Backend/app/api/routes/v1.py:1067`
- `AntiHub-Backend/app/api/routes/v1.py:1297`
- `AntiHub-Backend/app/api/routes/v1.py:1373`
- `AntiHub-Backend/app/api/routes/anthropic.py:126`
- `AntiHub-Backend/app/api/routes/anthropic.py:131`
- `AntiHub-Backend/app/api/routes/anthropic.py:162`
- `AntiHub-Backend/app/repositories/api_key_repository.py:139`
- `AntiHub-plugin/src/api/client.js:113`
- `AntiHub-plugin/src/server/routes.js:22`
- `AntiHub-plugin/src/server/routes.js:1598`
